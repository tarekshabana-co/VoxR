<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0D0C0A">
  <title>VoxR ‚Äî AI User Interviews</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: linear-gradient(165deg, #1A1816 0%, #141210 50%, #0D0C0A 100%); color: #F5F0EB; font-family: 'DM Sans', -apple-system, sans-serif; min-height: 100vh; min-height: 100dvh; overflow-x: hidden; }
    input, textarea, button { font-family: inherit; }
    input::placeholder, textarea::placeholder { color: #5A5550; }
    input:focus, textarea:focus { border-color: rgba(16,185,129,0.4) !important; outline: none; }
    ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
    @keyframes fade-up { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes blink { 0%,20%{opacity:.2}50%{opacity:1}80%,100%{opacity:.2} }
    .container { max-width: 520px; margin: 0 auto; padding: 20px 20px 40px; min-height: 100vh; min-height: 100dvh; display: flex; flex-direction: column; }
    .phase { animation: fade-up 0.6s ease-out; }
    .label { display: block; color: #8A8580; font-size: 12px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; margin-bottom: 8px; }
    .input { width: 100%; padding: 12px 16px; border-radius: 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); color: #F5F0EB; font-size: 14px; }
    .badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; }
    .card { padding: 16px; border-radius: 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); margin-bottom: 12px; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    .serif { font-family: 'Playfair Display', Georgia, serif; }
    .msg-bubble { max-width: 82%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.6; animation: fade-up 0.3s ease-out; }
    .msg-user { background: linear-gradient(135deg, #10B981, #34D399); color: #FFF; border-bottom-right-radius: 4px; margin-left: auto; }
    .msg-ai { background: rgba(255,255,255,0.06); color: #C8C3BE; border-bottom-left-radius: 4px; }
    .msg-label { font-size: 10px; opacity: 0.5; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .pulse-outer { position: absolute; width: 140px; height: 140px; border-radius: 50%; background: rgba(16,185,129,0.12); animation: pulse-ring 2s ease-out infinite; }
    .pulse-mid { position: absolute; width: 105px; height: 105px; border-radius: 50%; background: rgba(16,185,129,0.2); animation: pulse-ring 2s ease-out infinite 0.5s; }
    .pulse-vol { position: absolute; width: 85px; height: 85px; border-radius: 50%; background: rgba(16,185,129,0.15); transition: transform 0.15s ease-out; }
    .pulse-inner { width: 68px; height: 68px; border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center; transition: all 0.5s cubic-bezier(0.4,0,0.2,1); }
    .pulse-inner.active { background: linear-gradient(135deg, #10B981, #34D399); box-shadow: 0 0 50px rgba(16,185,129,0.4); }
    .pulse-inner:not(.active) { background: linear-gradient(135deg, #2D2D2D, #4A4A4A); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .hidden { display: none !important; }
    .thinking span { animation: blink 1.2s infinite; } .thinking span:nth-child(2) { animation-delay: 0.2s; } .thinking span:nth-child(3) { animation-delay: 0.4s; }
    .add-btn { width: 44px; height: 44px; border-radius: 12px; border: none; background: linear-gradient(135deg, #10B981, #34D399); color: #FFF; font-size: 20px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    /* Stepper */
    .stepper { display: flex; align-items: center; margin-bottom: 10px; }
    .step-circle { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; transition: all 0.3s; border: 2px solid rgba(255,255,255,0.1); color: #5A5550; background: transparent; }
    .step-circle.active { background: linear-gradient(135deg, #10B981, #34D399); border-color: transparent; color: #FFF; box-shadow: 0 4px 15px rgba(16,185,129,0.3); }
    .step-circle.done { background: rgba(16,185,129,0.15); border-color: #10B981; color: #10B981; }
    .step-line { flex: 1; height: 2px; background: rgba(255,255,255,0.08); margin: 0 8px; transition: background 0.3s; }
    .step-line.active { background: linear-gradient(90deg, #10B981, #34D399); }
    .step-labels { display: flex; justify-content: space-between; margin-bottom: 32px; }
    .step-label { font-size: 12px; font-weight: 500; color: #5A5550; transition: color 0.3s; text-align: center; width: 33.33%; }
    .step-label.active { color: #10B981; font-weight: 600; }
    /* Wizard Actions */
    .wizard-actions { display: flex; align-items: center; gap: 12px; margin-top: 32px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.06); }
    .wizard-actions .spacer { flex: 1; }
    .btn-back { padding: 12px 24px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: transparent; color: #C8C3BE; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-next { padding: 12px 24px; border-radius: 10px; border: none; background: linear-gradient(135deg, #10B981, #34D399); color: #FFF; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(16,185,129,0.3); }
    .btn-next:disabled { background: rgba(255,255,255,0.08); color: #5A5550; box-shadow: none; cursor: default; }
    /* Script Card */
    .script-card { border-radius: 14px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); overflow: hidden; }
    .script-row { display: flex; align-items: flex-start; gap: 12px; padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .script-row:last-child { border-bottom: none; }
    .script-badge { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; background: rgba(16,185,129,0.12); color: #10B981; }
    .script-content { flex: 1; min-width: 0; }
    .script-title { font-size: 13px; font-weight: 600; color: #C8C3BE; margin-bottom: 4px; }
    .script-text { font-size: 13px; color: #8A8580; line-height: 1.5; }
    .script-edit { background: none; border: none; color: #5A5550; cursor: pointer; padding: 4px; border-radius: 6px; flex-shrink: 0; }
    .script-edit:hover { color: #10B981; }
    .script-edit-input { width: 100%; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(16,185,129,0.3); color: #F5F0EB; font-size: 13px; line-height: 1.5; margin-top: 4px; resize: vertical; min-height: 40px; font-family: inherit; }
    .script-row-del { background: none; border: none; color: #5A5550; cursor: pointer; padding: 4px; font-size: 16px; line-height: 1; flex-shrink: 0; }
    .script-row-del:hover { color: #10B981; }
    /* RTL auto-detect */
    .input, .script-text, .script-edit-input, .msg-bubble { unicode-bidi: plaintext; }
    [dir="rtl"] .script-title { text-align: right; }
    /* Theme groups */
    .theme-group { margin-bottom: 2px; }
    .theme-header { display: flex; align-items: center; gap: 10px; padding: 14px 20px; background: rgba(16,185,129,0.04); border-bottom: 1px solid rgba(255,255,255,0.04); }
    .theme-icon { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; background: rgba(16,185,129,0.12); }
    .theme-label { font-size: 12px; font-weight: 600; color: #10B981; letter-spacing: 0.5px; text-transform: uppercase; }
    .theme-hint { font-size: 11px; color: #5A5550; font-weight: 400; text-transform: none; letter-spacing: 0; margin-left: 4px; }
    .branch-hint { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; color: #8A8580; background: rgba(255,255,255,0.04); padding: 2px 8px; border-radius: 6px; margin-top: 4px; }
  </style>
</head>
<body>
<div class="container" id="app">
  <!-- Top Bar -->
  <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0 24px;border-bottom:1px solid rgba(255,255,255,0.04);margin-bottom:28px;">
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#10B981,#34D399);display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:#FFF;">V</div>
      <span style="font-size:16px;font-weight:700;letter-spacing:-0.3px;">VoxR</span>
    </div>
    <span id="mode-badge" style="font-size:10px;padding:3px 8px;border-radius:8px;background:rgba(255,193,7,0.12);color:#FFC107;font-weight:600;">DEMO</span>
  </div>

  <!-- ‚ïê‚ïê‚ïê SETUP WIZARD ‚ïê‚ïê‚ïê -->
  <div id="phase-setup" class="phase">
    <div class="stepper" id="stepper">
      <div class="step-circle active" id="sc1">1</div>
      <div class="step-line" id="sl1"></div>
      <div class="step-circle" id="sc2">2</div>
      <div class="step-line" id="sl2"></div>
      <div class="step-circle" id="sc3">3</div>
    </div>
    <div class="step-labels">
      <span class="step-label active" id="slab1">Objective</span>
      <span class="step-label" id="slab2">Script</span>
      <span class="step-label" id="slab3">Settings</span>
    </div>

    <!-- STEP 1 -->
    <div id="ws1">
      <h2 class="serif" style="font-size:26px;font-weight:700;margin-bottom:24px;">Define Your Objective</h2>

      <!-- Language Selection -->
      <div style="margin-bottom:24px;">
        <label class="label">Interview Language</label>
        <div style="display:flex;gap:10px;" id="lang-buttons"></div>
      </div>

      <div style="margin-bottom:24px;"><label class="label">Research Objective</label><textarea id="objective" class="input" style="min-height:100px;resize:vertical;" placeholder="What do you want to learn from this research? Describe your goals..."></textarea></div>
      <div style="margin-bottom:24px;"><label class="label">Target Cohort</label><textarea id="cohort" class="input" style="min-height:80px;resize:vertical;" placeholder="Who are the participants? Age, location, role..."></textarea></div>

      <!-- Optional Custom Script -->
      <div style="margin-bottom:24px;">
        <button id="custom-script-toggle" onclick="toggleCustomScript()" style="display:flex;align-items:center;gap:8px;background:none;border:none;color:#8A8580;font-size:13px;font-weight:500;cursor:pointer;padding:0;">
          <span id="custom-script-arrow" style="transition:transform 0.2s;display:inline-block;">‚ñ∂</span>
          <span>I already have a script (optional)</span>
        </button>
        <div id="custom-script-section" class="hidden" style="margin-top:16px;padding:16px;border-radius:14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);">
          <p style="color:#5A5550;font-size:12px;margin-bottom:14px;line-height:1.5;">Paste your intro, questions (one per line), and outro. This will skip AI generation in the next step.</p>
          <div style="margin-bottom:14px;"><label class="label">Intro Message</label><textarea id="custom-intro" class="input" style="min-height:80px;resize:vertical;" placeholder="Hi! Thanks for joining us today. We're conducting research about..."></textarea></div>
          <div style="margin-bottom:14px;"><label class="label">Questions (one per line)</label><textarea id="custom-questions" class="input" style="min-height:120px;resize:vertical;" placeholder="What's your experience with...?&#10;How do you currently handle...?&#10;What frustrates you most about...?"></textarea></div>
          <div><label class="label">Outro Message</label><textarea id="custom-outro" class="input" style="min-height:80px;resize:vertical;" placeholder="Thank you so much for your time! Your insights are incredibly valuable and will help us improve..."></textarea></div>
        </div>
      </div>

      <div class="wizard-actions"><div class="spacer"></div><button class="btn-next" id="s1next" onclick="goStep(2)" disabled>Next ‚Üí</button></div>
    </div>

    <!-- STEP 2 -->
    <div id="ws2" class="hidden">
      <h2 class="serif" style="font-size:26px;font-weight:700;margin-bottom:8px;">Script Preview</h2>
      <p style="color:#8A8580;font-size:13px;margin-bottom:20px;line-height:1.5;">Questions are grouped by theme. The AI will follow-up naturally within each group and adapt based on responses.</p>
      <div id="script-loading" class="hidden" style="text-align:center;padding:40px 0;">
        <div style="width:40px;height:40px;border-radius:50%;border:3px solid rgba(16,185,129,0.2);border-top-color:#10B981;animation:spin 1s linear infinite;margin:0 auto 16px;"></div>
        <div style="color:#C8C3BE;font-size:14px;font-weight:500;">Generating interview script...</div>
        <div style="color:#5A5550;font-size:12px;margin-top:4px;">Claude is crafting questions based on your objective</div>
      </div>
      <div id="script-card" class="script-card"></div>
      <div id="add-q-wrap" style="display:flex;gap:8px;margin-top:12px;">
        <input id="add-q-in" class="input" style="flex:1;" placeholder="Add another question..." onkeydown="if(event.key==='Enter')addQ()">
        <button class="add-btn" onclick="addQ()">+</button>
      </div>
      <div class="wizard-actions"><button class="btn-back" onclick="goStep(1)">‚Üê Back</button><div class="spacer"></div><button class="btn-next" id="s2next" onclick="goStep(3)">Next ‚Üí</button></div>
    </div>

    <!-- STEP 3 -->
    <div id="ws3" class="hidden">
      <h2 class="serif" style="font-size:26px;font-weight:700;margin-bottom:24px;">Interview Settings</h2>

      <div class="card" style="margin-bottom:24px;">
        <h3 style="font-size:15px;font-weight:600;margin-bottom:6px;">Voice Integration</h3>
        <p style="color:#5A5550;font-size:13px;line-height:1.5;margin-bottom:14px;">Paste your Vapi public key for real voice interviews, or leave blank for text demo.</p>
        <input id="vapi-key" class="input" type="password" placeholder="Vapi Public Key" oninput="updateMode()">
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center;">
          <span id="mode-status" style="display:inline-flex;padding:4px 10px;border-radius:8px;background:rgba(255,193,7,0.12);color:#FFC107;font-size:12px;font-weight:600;">‚óè Demo Mode</span>
          <span id="mode-hint" style="color:#5A5550;font-size:11px;">Get a key free at vapi.ai</span>
        </div>
      </div>
      <div style="margin-bottom:24px;"><label class="label">Interview Style</label><div style="display:flex;gap:10px;flex-wrap:wrap;" id="tone-buttons"></div></div>
      <div style="margin-bottom:24px;"><label class="label">Project Name (optional)</label><input id="project-name" class="input" placeholder="e.g., Onboarding Flow Research"></div>
      <div class="wizard-actions"><button class="btn-back" onclick="goStep(2)">‚Üê Back</button><div class="spacer"></div><button class="btn-next" id="start-btn" onclick="startInterview()">Start Interview ‚Üí</button></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê LIVE ‚ïê‚ïê‚ïê -->
  <div id="phase-live" class="phase hidden" style="flex:1;display:flex;flex-direction:column;">
    <div style="text-align:center;padding:10px 0 12px;position:sticky;top:0;z-index:10;background:linear-gradient(to bottom,#141210 80%,transparent);">
      <div style="position:relative;width:140px;height:140px;display:flex;align-items:center;justify-content:center;margin:0 auto;" id="pulse-container">
        <div class="pulse-inner" id="pulse-core"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg></div>
      </div>
      <div id="timer" class="mono" style="margin-top:14px;font-size:42px;font-weight:700;letter-spacing:-1px;">00:00</div>
      <div style="display:flex;justify-content:center;gap:8px;margin-top:6px;">
        <span id="live-status" class="badge" style="padding:4px 12px;font-size:12px;background:rgba(255,193,7,0.15);color:#FFC107;">‚óè CONNECTING</span>
        <span id="voice-badge" class="badge hidden" style="padding:4px 12px;font-size:12px;background:rgba(156,39,176,0.12);color:#CE93D8;">VOICE</span>
      </div>
      <div id="live-project" style="color:#5A5550;font-size:13px;margin-top:6px;"></div>
    </div>
    <div id="transcript" style="flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;gap:12px;">
      <div id="transcript-empty" style="text-align:center;color:#3A3530;font-size:14px;margin-top:40px;">Waiting for conversation to begin...</div>
    </div>
    <div style="padding:12px 0 8px;position:sticky;bottom:0;z-index:10;background:linear-gradient(to top,#141210 80%,transparent);padding-top:20px;">
      <div id="voice-active-hint" class="hidden" style="font-size:12px;color:#4CAF50;text-align:center;margin-bottom:10px;">üé§ Speak naturally ‚Äî the AI is listening</div>
      <div id="demo-input-wrapper">
        <div style="font-size:11px;color:#5A5550;text-align:center;margin-bottom:8px;">Type your answers below</div>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <input id="user-input" class="input" style="flex:1;" placeholder="Type your answer..." onkeydown="if(event.key==='Enter'&&!isThinking)sendMsg()">
          <button class="add-btn" style="border-radius:12px;" onclick="sendMsg()" id="send-btn">‚Üë</button>
        </div>
      </div>
      <button onclick="endInterview()" style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(16,185,129,0.3);background:rgba(16,185,129,0.08);color:#10B981;font-size:14px;font-weight:600;cursor:pointer;">End Interview</button>
    </div>
  </div>

  <div id="phase-review" class="phase hidden"></div>
  <div id="phase-synthesis" class="phase hidden"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/balacodeio/Vapi-Web-UMD@latest/dist/latest/vapi-web-bundle.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let currentPhase='setup', wizStep=1, vapiInstance=null, isVoiceMode=false, isThinking=false;
let timerInterval=null, duration=0, transcriptData=[], interviews=[], selectedTone='Casual & Friendly';
let scriptIntro='', scriptOutro='', questions=[], editIdx=null;
let scriptGroups=[]; // [{theme:'...', icon:'üîç', questions:['...'], flow:'...'}]
let selectedLang='en'; // 'en' or 'ar-eg'

// Language configs
const LANG_CONFIG = {
  'en': {
    label: 'English',
    flag: 'üá∫üá∏',
    voice: { provider: '11labs', voiceId: '21m00Tcm4TlvDq8ikWAM', model: 'eleven_flash_v2_5', stability: 0.6, similarityBoost: 0.8 },
    transcriber: { provider: 'deepgram', model: 'nova-2', language: 'en' },
    systemLang: 'Respond in English.',
  },
  'ar-eg': {
    label: 'ŸÖÿµÿ±Ÿä',
    flag: 'üá™üá¨',
    voice: { provider: 'azure', voiceId: 'ar-EG-SalmaNeural' },
    transcriber: { provider: 'talkscriber', model: 'whisper', language: 'ar' },
    systemLang: 'You MUST respond ONLY in Egyptian Arabic (ÿßŸÑÿπÿßŸÖŸäÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ©). Never use English. Never use any English words. Use casual Egyptian dialect only, not Modern Standard Arabic (ŸÅÿµÿ≠Ÿâ). Speak exactly like a friend chatting in Cairo.',
  }
};

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
function init(){
  renderTones();
  renderLangs();
  document.getElementById('objective').addEventListener('input',()=>{document.getElementById('s1next').disabled=!document.getElementById('objective').value.trim()});
  console.log('[VoxR] Init. Vapi:',typeof Vapi!=='undefined');
}

// ‚ïê‚ïê‚ïê WIZARD ‚ïê‚ïê‚ïê
function toggleCustomScript(){
  const sec=document.getElementById('custom-script-section');
  const arrow=document.getElementById('custom-script-arrow');
  const isHidden=sec.classList.contains('hidden');
  sec.classList[isHidden?'remove':'add']('hidden');
  arrow.style.transform=isHidden?'rotate(90deg)':'rotate(0deg)';
}

function hasCustomScript(){
  const qs=document.getElementById('custom-questions').value.trim();
  return qs.length>10; // at least some meaningful content
}

async function loadCustomScript(){
  const intro=document.getElementById('custom-intro').value.trim();
  const rawScript=document.getElementById('custom-questions').value.trim();
  const outro=document.getElementById('custom-outro').value.trim();
  scriptIntro=intro||'Hi! Thanks for taking the time to chat today.';
  scriptOutro=outro||'Thank you so much for your time!';

  // Show loading while Claude parses the script
  document.getElementById('script-loading').classList.remove('hidden');
  document.getElementById('script-card').classList.add('hidden');
  document.getElementById('add-q-wrap').classList.add('hidden');

  try{
    const r=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1500,
        messages:[{role:'user',content:`You are parsing a user-provided interview script into structured question groups.

RAW SCRIPT:
${rawScript}

Parse this into structured groups. Your job:
1. IGNORE any lines that are separators (dashes, equals, asterisks, blank lines, horizontal rules)
2. IGNORE any lines that are section headers/titles ‚Äî instead USE them as group theme names
3. ONLY extract actual interview questions ‚Äî things that would be asked to a participant
4. Group related questions together under a theme
5. If questions have conditional logic (e.g. "if yes, ask..." or "follow up with..."), note that in the flow field
6. Strip any numbering prefixes (1., Q1:, -, ‚Ä¢, etc.) from questions

Respond ONLY in JSON (no markdown, no backticks):
{
  "groups": [
    {
      "theme": "Theme name in English",
      "icon": "single emoji",
      "flow": "English note on how questions relate or branch",
      "questions": ["Clean question text", "Another question"]
    }
  ]
}

If you can't identify clear themes, put all questions in one group called "Interview Questions".
Keep question text in its ORIGINAL language ‚Äî do not translate.`}]})});
    const d=await r.json(),t=d.content?.map(b=>b.text||'').join('')||'',p=JSON.parse(t.replace(/```json|```/g,'').trim());
    scriptGroups=p.groups||[];
    questions=scriptGroups.flatMap(g=>g.questions);
  }catch(e){
    console.error('[VoxR] Custom script parse error:',e);
    // Fallback: smart line filter
    const lines=rawScript.split('\n').map(l=>l.trim()).filter(l=>{
      if(!l) return false;
      if(/^[-=_*~]{3,}$/.test(l)) return false; // separators
      if(/^#{1,3}\s/.test(l)) return false; // markdown headers
      if(l.length<10) return false; // too short to be a question
      if(!/[?ÿü]/.test(l)&&l.length<30) return false; // no question mark and short = likely a header
      return true;
    }).map(l=>l.replace(/^[\d]+[.):]\s*/,'').replace(/^[-‚Ä¢‚óè]\s*/,'').replace(/^Q\d+[.:]\s*/i,'').trim());
    scriptGroups=[{theme:'Interview Questions',icon:'üìã',flow:'Questions will be asked in order',questions:lines}];
    questions=lines;
  }

  document.getElementById('script-loading').classList.add('hidden');
  document.getElementById('script-card').classList.remove('hidden');
  document.getElementById('add-q-wrap').classList.remove('hidden');
  renderScript();
}

async function goStep(s){
  if(s===2&&wizStep===1){
    if(!document.getElementById('objective').value.trim())return;
    if(hasCustomScript()) await loadCustomScript();
    else await genScript();
  }
  wizStep=s;
  for(let i=1;i<=3;i++)document.getElementById('ws'+i).classList[i===s?'remove':'add']('hidden');
  for(let i=1;i<=3;i++){
    const c=document.getElementById('sc'+i),l=document.getElementById('slab'+i);
    c.classList.remove('active','done');l.classList.remove('active');
    if(i===s){c.classList.add('active');l.classList.add('active');c.innerHTML=i;}
    else if(i<s){c.classList.add('done');c.innerHTML='‚úì';}
    else c.innerHTML=i;
  }
  document.getElementById('sl1').classList[s>1?'add':'remove']('active');
  document.getElementById('sl2').classList[s>2?'add':'remove']('active');
}

// ‚ïê‚ïê‚ïê AI SCRIPT GENERATION ‚ïê‚ïê‚ïê
async function genScript(){
  const obj=document.getElementById('objective').value.trim(),coh=document.getElementById('cohort').value.trim();
  document.getElementById('script-loading').classList.remove('hidden');
  document.getElementById('script-card').classList.add('hidden');
  document.getElementById('add-q-wrap').classList.add('hidden');
  try{
    const r=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1500,
        messages:[{role:'user',content:`You are an expert user researcher designing an interview script.

RESEARCH OBJECTIVE: ${obj}
TARGET COHORT: ${coh||'General users'}
SCRIPT LANGUAGE: ${selectedLang==='ar-eg'?'Egyptian Arabic (ÿßŸÑÿπÿßŸÖŸäÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ©) for the intro, questions, and outro ONLY. Theme names, icons, and flow hints must stay in English.':'English'}

Respond ONLY in JSON (no markdown, no backticks):
{
  "intro": "Warm conversational intro (2-3 sentences)",
  "groups": [
    {
      "theme": "Theme name in English (e.g. Current Experience, Pain Points)",
      "icon": "single emoji",
      "flow": "Brief English note on how these questions connect",
      "questions": ["Q1", "Q2"]
    }
  ],
  "outro": "Warm closing (1-2 sentences)"
}

RULES:
- Create 2-4 thematic groups with 1-3 questions each (5-7 questions total)
- Group related questions together ‚Äî show the interviewer's logical flow
- The "flow" field should explain the relationship between questions in English (e.g. "Ask Q2 only if they say yes to Q1", "Use Q2 to dig deeper into whatever they mention in Q1")
- "theme" and "flow" are ALWAYS in English regardless of script language
- Questions should be open-ended and conversational
- Flow from broad discovery ‚Üí specific pain points ‚Üí ideal solutions${selectedLang==='ar-eg'?'\n- The "intro", "questions", and "outro" values MUST be in Egyptian Arabic dialect (ÿπÿßŸÖŸäÿ© ŸÖÿµÿ±Ÿäÿ©), NOT Modern Standard Arabic. Theme names and flow hints stay in English.':''}`}]})});
    const d=await r.json(),t=d.content?.map(b=>b.text||'').join('')||'',p=JSON.parse(t.replace(/```json|```/g,'').trim());
    scriptIntro=p.intro||'Hi! Thanks for chatting. This will take about 10 minutes.';
    scriptGroups=p.groups||[];
    // Flatten questions for Vapi system prompt
    questions=scriptGroups.flatMap(g=>g.questions);
    scriptOutro=p.outro||'Thank you so much for your time!';
  }catch(e){
    console.error('[VoxR] Script gen error:',e);
    scriptIntro='Hi! I\'m conducting research about '+obj.substring(0,60)+'. This will take about 10-15 minutes.';
    scriptGroups=[
      {theme:'Current Experience',icon:'üîç',flow:'Start broad to understand their world',questions:['Can you walk me through how you currently handle this?','What tools or workarounds are you using today?']},
      {theme:'Pain Points',icon:'‚ö°',flow:'Dig into frustrations from their current approach',questions:['What\'s the most frustrating part of your current workflow?','If you could wave a magic wand and fix one thing, what would it be?']},
      {theme:'Ideal Solution',icon:'üí°',flow:'Explore what good looks like to them',questions:['What would make you switch to a new solution?']},
    ];
    questions=scriptGroups.flatMap(g=>g.questions);
    scriptOutro='Thank you so much for your time!';
  }
  document.getElementById('script-loading').classList.add('hidden');
  document.getElementById('script-card').classList.remove('hidden');
  document.getElementById('add-q-wrap').classList.remove('hidden');
  renderScript();
}

function renderScript(){
  const c=document.getElementById('script-card');
  const rtl=selectedLang==='ar-eg'?' dir="rtl"':'';
  let h='';

  // Intro
  h+=sRow('I','Intro',scriptIntro,'intro',false,rtl);

  // Themed question groups
  let qIdx=0;
  scriptGroups.forEach((g,gi)=>{
    h+=`<div class="theme-group">`;
    h+=`<div class="theme-header"${rtl}><div class="theme-icon">${g.icon||'üìã'}</div><div><span class="theme-label">${g.theme}</span>${g.flow?'<div class="branch-hint">‚Ü≥ '+g.flow+'</div>':''}</div></div>`;
    g.questions.forEach((q,qi)=>{
      h+=sRow('Q'+(qIdx+1),'Question '+(qIdx+1),q,'q-'+gi+'-'+qi,true,rtl);
      qIdx++;
    });
    h+=`</div>`;
  });

  // Outro
  h+=sRow('O','Outro',scriptOutro,'outro',false,rtl);
  c.innerHTML=h;
}

function sRow(badge,title,text,id,canDel,rtl){
  rtl=rtl||'';
  if(editIdx===id) return `<div class="script-row"${rtl}><div class="script-badge">${badge}</div><div class="script-content"><div class="script-title">${title}</div><textarea class="script-edit-input" id="ei-${id}"${rtl}>${text}</textarea><div style="display:flex;gap:6px;margin-top:6px;"><button onclick="saveE('${id}')" style="padding:5px 12px;border-radius:6px;border:none;background:#10B981;color:#FFF;font-size:12px;font-weight:600;cursor:pointer;">Save</button><button onclick="cancelE()" style="padding:5px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#8A8580;font-size:12px;cursor:pointer;">Cancel</button></div></div></div>`;
  return `<div class="script-row"${rtl}><div class="script-badge">${badge}</div><div class="script-content"><div class="script-title">${title}</div><div class="script-text"${rtl}>${text}</div></div>${canDel?'<button class="script-row-del" onclick="delQ(\''+id+'\')" title="Remove">√ó</button>':''}<button class="script-edit" onclick="startE('${id}')" title="Edit"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button></div>`;
}

function startE(id){editIdx=id;renderScript();setTimeout(()=>{const e=document.getElementById('ei-'+id);if(e){e.focus();e.setSelectionRange(e.value.length,e.value.length);}},50);}
function saveE(id){
  const e=document.getElementById('ei-'+id);if(!e||!e.value.trim())return;
  if(id==='intro') scriptIntro=e.value.trim();
  else if(id==='outro') scriptOutro=e.value.trim();
  else if(id.startsWith('q-')){
    const parts=id.replace('q-','').split('-');
    const gi=parseInt(parts[0]),qi=parseInt(parts[1]);
    if(scriptGroups[gi]) scriptGroups[gi].questions[qi]=e.value.trim();
    questions=scriptGroups.flatMap(g=>g.questions);
  }
  editIdx=null;renderScript();
}
function cancelE(){editIdx=null;renderScript();}
function delQ(id){
  const parts=id.replace('q-','').split('-');
  const gi=parseInt(parts[0]),qi=parseInt(parts[1]);
  if(scriptGroups[gi]){
    scriptGroups[gi].questions.splice(qi,1);
    if(scriptGroups[gi].questions.length===0) scriptGroups.splice(gi,1);
    questions=scriptGroups.flatMap(g=>g.questions);
  }
  renderScript();
}
function addQ(){
  const inp=document.getElementById('add-q-in');
  if(inp.value.trim()){
    // Add to last group, or create a new one
    if(scriptGroups.length===0) scriptGroups.push({theme:'Additional Questions',icon:'‚ûï',flow:'',questions:[]});
    scriptGroups[scriptGroups.length-1].questions.push(inp.value.trim());
    questions=scriptGroups.flatMap(g=>g.questions);
    inp.value='';renderScript();
  }
}

// ‚ïê‚ïê‚ïê MODE ‚ïê‚ïê‚ïê
function updateMode(){
  const key=document.getElementById('vapi-key').value.trim();isVoiceMode=key.length>10;
  const b=document.getElementById('mode-badge'),st=document.getElementById('mode-status'),h=document.getElementById('mode-hint');
  if(isVoiceMode){
    b.style.background='rgba(76,175,80,0.12)';b.style.color='#4CAF50';b.textContent='VOICE';
    st.style.background='rgba(76,175,80,0.12)';st.style.color='#4CAF50';st.textContent='‚óè Voice Ready';
    h.textContent='Real-time voice enabled';
    try{if(typeof Vapi!=='undefined'){vapiInstance=new Vapi(key);setupVapi();console.log('[VoxR] Vapi ok');}}catch(e){console.error('[VoxR] Vapi err:',e);}
  }else{
    b.style.background='rgba(255,193,7,0.12)';b.style.color='#FFC107';b.textContent='DEMO';
    st.style.background='rgba(255,193,7,0.12)';st.style.color='#FFC107';st.textContent='‚óè Demo Mode';
    h.textContent='Get a key free at vapi.ai';vapiInstance=null;
  }
}

// ‚ïê‚ïê‚ïê VAPI ‚ïê‚ïê‚ïê
function setupVapi(){
  if(!vapiInstance)return;
  vapiInstance.on('call-start',()=>{setLS('live');addPR();document.getElementById('pulse-core').classList.add('active');});
  vapiInstance.on('call-end',()=>{setLS('ended');rmPR();document.getElementById('pulse-core').classList.remove('active');});
  vapiInstance.on('volume-level',v=>{const e=document.getElementById('pulse-vol');if(e)e.style.transform='scale('+(1+v*0.4)+')';});
  vapiInstance.on('message',m=>{if(m.type==='transcript'&&m.transcriptType==='final')addTM(m.role,m.transcript);});
  vapiInstance.on('error',e=>{console.error('[VoxR] err:',e);addTM('assistant','‚ö†Ô∏è '+( e?.message||e?.error?.message||'Voice error'));});
}
function setLS(s){const e=document.getElementById('live-status');if(s==='live'){e.textContent='‚óè LIVE';e.style.background='rgba(76,175,80,0.15)';e.style.color='#4CAF50';}else if(s==='connecting'){e.textContent='‚óè CONNECTING';e.style.background='rgba(255,193,7,0.15)';e.style.color='#FFC107';}else{e.textContent='‚óè ENDED';e.style.background='rgba(16,185,129,0.15)';e.style.color='#10B981';}}

// ‚ïê‚ïê‚ïê INTERVIEW ‚ïê‚ïê‚ïê
function startInterview(){
  transcriptData=[];duration=0;showPhase('live');
  applyLangDirection(); // ensure transcript input RTL is set
  const cfg=getCfg();
  document.getElementById('live-project').textContent=cfg.projectName||'Interview Session';
  document.getElementById('transcript').innerHTML='<div id="transcript-empty" style="text-align:center;color:#3A3530;font-size:14px;margin-top:40px;">Waiting for conversation...</div>';
  timerInterval=setInterval(()=>{duration++;document.getElementById('timer').textContent=fmtT(duration);},1000);

  if(isVoiceMode&&vapiInstance){
    document.getElementById('demo-input-wrapper').classList.add('hidden');
    document.getElementById('voice-active-hint').classList.remove('hidden');
    document.getElementById('voice-badge').classList.remove('hidden');
    setLS('connecting');
    const lang=LANG_CONFIG[selectedLang];
    const groupScript=scriptGroups.map(g=>`\n[${g.theme}] (${g.flow||'ask in order'})\n${g.questions.map((q,i)=>'  '+(i+1)+'. '+q).join('\n')}`).join('\n');
    const sp=`You are a skilled user researcher. Style: ${cfg.tone}.\n${lang.systemLang}\n\nOBJECTIVE: ${cfg.objective}\nCOHORT: ${cfg.cohort}\n\nSCRIPT:\nIntro: ${scriptIntro}\n${groupScript}\nOutro: ${scriptOutro}\n\nINSTRUCTIONS:\n- Start with intro, then work through each theme group\n- Within each group, follow the flow guidance (e.g. if it says "ask Q2 only if they say yes", respect that)\n- Listen carefully, ask follow-ups based on what user actually says\n- Reference what user said ‚Äî don't just read questions robotically\n- Keep natural and conversational, under 10 min\n- Close with outro`;
    vapiInstance.start({
      model:{provider:"openai",model:"gpt-4o",messages:[{role:"system",content:sp}],temperature:0.7},
      voice:lang.voice,
      transcriber:lang.transcriber,
      name:cfg.projectName||"Interview",firstMessage:scriptIntro,silenceTimeoutSeconds:30,maxDurationSeconds:900,
    }).catch(e=>{addTM('assistant','‚ö†Ô∏è '+( e?.message||JSON.stringify(e)));setLS('ended');});
    document.getElementById('pulse-core').classList.add('active');addPR();
  }else{
    document.getElementById('demo-input-wrapper').classList.remove('hidden');
    document.getElementById('voice-active-hint').classList.add('hidden');
    document.getElementById('voice-badge').classList.add('hidden');
    document.getElementById('pulse-core').classList.add('active');
    setLS('live');addPR();
    setTimeout(()=>addTM('assistant',scriptIntro||'Hi! Shall we get started?'),1200);
  }
}

function endInterview(){
  if(timerInterval)clearInterval(timerInterval);
  if(isVoiceMode&&vapiInstance)try{vapiInstance.stop();}catch(e){}
  rmPR();document.getElementById('pulse-core').classList.remove('active');setLS('ended');
  if(transcriptData.length>0)interviews.push({transcript:[...transcriptData],duration,config:getCfg()});
  renderReview();showPhase('review');
}

// ‚ïê‚ïê‚ïê MESSAGES ‚ïê‚ïê‚ïê
async function sendMsg(){
  const inp=document.getElementById('user-input'),t=inp.value.trim();
  if(!t||isThinking)return;inp.value='';addTM('user',t);
  if(!isVoiceMode){
    isThinking=true;document.getElementById('send-btn').style.opacity='0.5';showTB();
    try{
      const cfg=getCfg();
      const r=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,
          messages:[{role:'user',content:'You are a user researcher. Style: '+cfg.tone+'. Objective: '+cfg.objective+'. Questions: '+cfg.questions.join('; ')+'\n\nInterviewee said: "'+t+'"\n\nRespond as interviewer, 1-3 sentences. Plain text.'}]})});
      const d=await r.json();hideTB();addTM('assistant',d.content?.[0]?.text||'Tell me more?');
    }catch(e){hideTB();addTM('assistant','Can you tell me more about that?');}
    finally{isThinking=false;document.getElementById('send-btn').style.opacity='1';}
  }
}

function addTM(role,text){
  const c=document.getElementById('transcript'),em=document.getElementById('transcript-empty');if(em)em.remove();
  transcriptData.push({role,text,time:new Date().toISOString()});
  const w=document.createElement('div');w.style.cssText='display:flex;justify-content:'+(role==='user'?'flex-end':'flex-start')+';animation:fade-up 0.3s ease-out;';
  const b=document.createElement('div');b.className='msg-bubble '+(role==='user'?'msg-user':'msg-ai');
  b.innerHTML='<div class="msg-label">'+(role==='user'?'Interviewee':'AI Interviewer')+'</div>'+text;
  w.appendChild(b);c.appendChild(w);c.scrollTop=c.scrollHeight;
}
function showTB(){const c=document.getElementById('transcript'),d=document.createElement('div');d.id='tb';d.style.cssText='display:flex;justify-content:flex-start;';d.innerHTML='<div class="msg-bubble msg-ai thinking"><span>‚óè</span><span> ‚óè</span><span> ‚óè</span></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function hideTB(){const e=document.getElementById('tb');if(e)e.remove();}

// ‚ïê‚ïê‚ïê PULSE ‚ïê‚ïê‚ïê
function addPR(){rmPR();const c=document.getElementById('pulse-container');['pulse-outer','pulse-mid','pulse-vol'].forEach(cls=>{const d=document.createElement('div');d.className=cls;d.id=cls;c.insertBefore(d,c.firstChild);});}
function rmPR(){['pulse-outer','pulse-mid','pulse-vol'].forEach(id=>{const e=document.getElementById(id);if(e)e.remove();});}

// ‚ïê‚ïê‚ïê REVIEW ‚ïê‚ïê‚ïê
function renderReview(){
  const el=document.getElementById('phase-review');
  el.innerHTML='<div style="margin-bottom:32px;"><div class="badge" style="background:rgba(76,175,80,0.12);color:#4CAF50;margin-bottom:16px;">Completed</div><h1 class="serif" style="font-size:28px;font-weight:700;margin-bottom:8px;">Interview Sessions</h1><p style="color:#8A8580;font-size:14px;">'+interviews.length+' interview'+(interviews.length!==1?'s':'')+' completed</p></div>'+
    interviews.map((iv,i)=>'<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><span style="color:#F5F0EB;font-weight:600;">Session '+(i+1)+'</span><span class="mono" style="color:#8A8580;font-size:12px;">'+fmtT(iv.duration)+' ¬∑ '+iv.transcript.length+' msgs</span></div><div style="color:#5A5550;font-size:13px;line-height:1.5;">'+iv.transcript.slice(0,2).map(m=>m.text).join(' ‚Üí ').substring(0,140)+'...</div></div>').join('')+
    '<div style="display:flex;gap:10px;margin-top:24px;"><button onclick="wizStep=1;goStep(1);showPhase(\'setup\')" style="flex:1;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.06);color:#C8C3BE;font-size:14px;font-weight:600;cursor:pointer;">+ New</button><button onclick="doSynth()" style="flex:1;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#10B981,#34D399);color:#FFF;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 8px 30px rgba(16,185,129,0.3);">Synthesize ‚Üí</button></div>';
}

// ‚ïê‚ïê‚ïê SYNTHESIS ‚ïê‚ïê‚ïê
async function doSynth(){
  showPhase('synthesis');const el=document.getElementById('phase-synthesis');
  el.innerHTML='<div style="text-align:center;padding-top:80px;"><div style="width:48px;height:48px;border-radius:50%;border:3px solid rgba(16,185,129,0.2);border-top-color:#10B981;animation:spin 1s linear infinite;margin:0 auto 20px;"></div><div style="color:#C8C3BE;font-size:16px;font-weight:600;">Analyzing...</div></div>';
  const cfg=getCfg();let s;
  try{
    const txt=interviews.map((iv,i)=>'=== S'+(i+1)+' ('+fmtT(iv.duration)+') ===\n'+iv.transcript.map(m=>(m.role==='user'?'USER':'AI')+': '+m.text).join('\n')).join('\n\n');
    const r=await fetch('/api/claude',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,
        messages:[{role:'user',content:'Senior researcher.\n\nOBJ: '+cfg.objective+'\nCOHORT: '+cfg.cohort+'\n\nTRANSCRIPTS:\n'+txt+'\n\nJSON only:\n{"themes":[{"label":"T","sentiment":"positive|negative|mixed","frequency":"X of Y","insight":"S"}],"recommendations":["R"],"quotes":[{"text":"Q","session":1,"context":"C"}],"summary":"S"}\n\n2-4 themes, 3-5 recs, 2-4 quotes.'}]})});
    const d=await r.json();s=JSON.parse((d.content?.map(b=>b.text||'').join('')||'').replace(/```json|```/g,'').trim());
  }catch(e){s={themes:[{label:"Pain Points",sentiment:"negative",frequency:interviews.length+"/"+interviews.length,insight:"Frustration with current workflows."}],recommendations:["Focus on top pain","Flexible onboarding","Clear aha moment"],quotes:interviews.slice(0,2).map((iv,i)=>({text:iv.transcript.find(m=>m.role==='user')?.text||'-',session:i+1,context:"Response"})),summary:"Users revealed frustration and interest in alternatives."};}
  renderSynth(s,cfg);
}

function renderSynth(s,cfg){
  const el=document.getElementById('phase-synthesis');
  const sentBg=t=>t==='negative'?'rgba(16,185,129,0.15)':t==='positive'?'rgba(76,175,80,0.15)':'rgba(255,193,7,0.15)';
  const sentCol=t=>t==='negative'?'#10B981':t==='positive'?'#4CAF50':'#FFC107';
  el.innerHTML='<div style="margin-bottom:28px;"><div class="badge" style="background:rgba(156,39,176,0.12);color:#CE93D8;margin-bottom:16px;">AI Synthesis</div><h1 class="serif" style="font-size:28px;font-weight:700;margin-bottom:8px;">Research Findings</h1><p style="color:#8A8580;font-size:14px;">'+(cfg.projectName||'Project')+' ¬∑ '+interviews.length+' session'+(interviews.length!==1?'s':'')+'</p></div>'+
    (s.summary?'<div style="padding:16px;border-radius:14px;margin-bottom:24px;background:linear-gradient(135deg,rgba(16,185,129,0.08),rgba(156,39,176,0.06));border:1px solid rgba(16,185,129,0.12);"><div style="color:#34D399;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;">Executive Summary</div><p style="color:#E0DBD6;font-size:14px;line-height:1.7;">'+s.summary+'</p></div>':'')+
    '<h2 style="color:#C8C3BE;font-size:13px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:12px;">Key Themes</h2>'+
    s.themes.map(t=>'<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px;"><span style="color:#F5F0EB;font-weight:600;">'+t.label+'</span><div style="display:flex;gap:6px;"><span style="font-size:11px;padding:3px 10px;border-radius:10px;font-weight:600;background:'+sentBg(t.sentiment)+';color:'+sentCol(t.sentiment)+';">'+t.sentiment+'</span><span class="mono" style="color:#5A5550;font-size:11px;">'+t.frequency+'</span></div></div><p style="color:#8A8580;font-size:13px;line-height:1.6;">'+t.insight+'</p></div>').join('')+
    '<h2 style="color:#C8C3BE;font-size:13px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin:24px 0 12px;">Recommendations</h2><div style="padding:16px;border-radius:14px;background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.12);">'+
    s.recommendations.map((r,i)=>'<div style="display:flex;gap:10px;padding:10px 0;'+(i<s.recommendations.length-1?'border-bottom:1px solid rgba(255,255,255,0.04);':'')+'"><span class="mono" style="color:#10B981;font-weight:700;font-size:13px;min-width:24px;">'+String(i+1).padStart(2,'0')+'</span><span style="color:#C8C3BE;font-size:14px;line-height:1.5;">'+r+'</span></div>').join('')+'</div>'+
    (s.quotes?.length?'<h2 style="color:#C8C3BE;font-size:13px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin:24px 0 12px;">Notable Quotes</h2>'+s.quotes.map(q=>'<div style="padding:14px 16px;border-radius:14px;margin-bottom:8px;background:rgba(255,255,255,0.03);border-left:3px solid #10B981;"><p style="color:#C8C3BE;font-size:14px;line-height:1.6;font-style:italic;margin-bottom:6px;">&ldquo;'+q.text+'&rdquo;</p><span style="color:#5A5550;font-size:12px;">‚Äî Session '+q.session+'</span></div>').join(''):'')+
    '<button onclick="showPhase(\'review\')" style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.06);color:#C8C3BE;font-size:14px;font-weight:600;cursor:pointer;margin-top:24px;">‚Üê Back</button>';
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function showPhase(p){currentPhase=p;['setup','live','review','synthesis'].forEach(x=>document.getElementById('phase-'+x).classList[x===p?'remove':'add']('hidden'));}
function renderLangs(){
  const el=document.getElementById('lang-buttons');
  Object.entries(LANG_CONFIG).forEach(([key,cfg])=>{
    const b=document.createElement('button');
    const isActive=key===selectedLang;
    b.style.cssText='padding:10px 18px;border-radius:10px;border:none;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s;display:flex;align-items:center;gap:8px;'+(isActive?'background:linear-gradient(135deg,#10B981,#34D399);color:#FFF;box-shadow:0 4px 15px rgba(16,185,129,0.3);':'background:rgba(255,255,255,0.06);color:#8A8580;');
    b.innerHTML=cfg.flag+' '+cfg.label;
    b.onclick=()=>{
      selectedLang=key;
      el.querySelectorAll('button').forEach(x=>{x.style.background='rgba(255,255,255,0.06)';x.style.color='#8A8580';x.style.boxShadow='none';});
      b.style.background='linear-gradient(135deg,#10B981,#34D399)';b.style.color='#FFF';b.style.boxShadow='0 4px 15px rgba(16,185,129,0.3)';
      applyLangDirection();
    };
    el.appendChild(b);
  });
}

function applyLangDirection(){
  const isAr=selectedLang==='ar-eg';
  const dir=isAr?'rtl':'ltr';
  // Only script fields get RTL ‚Äî objective and cohort stay LTR English
  ['custom-intro','custom-questions','custom-outro'].forEach(id=>{
    const e=document.getElementById(id);
    if(e) e.dir=dir;
  });
  // Objective & cohort always LTR
  ['objective','cohort'].forEach(id=>{
    const e=document.getElementById(id);
    if(e) e.dir='ltr';
  });
  // Custom script placeholders switch to Arabic
  const ci=document.getElementById('custom-intro');
  const cq=document.getElementById('custom-questions');
  const co=document.getElementById('custom-outro');
  if(isAr){
    if(ci) ci.placeholder='ÿ£ŸáŸÑÿßŸã! ÿ¥ŸÉÿ±ÿßŸã ÿ•ŸÜŸÉ ŸÖÿπÿßŸÜÿß ÿßŸÑŸÜŸáÿßÿ±ÿØÿ©. ÿ•ÿ≠ŸÜÿß ÿ®ŸÜÿπŸÖŸÑ ÿ®ÿ≠ÿ´ ÿπŸÜ...';
    if(cq) cq.placeholder='ÿ•ŸäŸá ÿ™ÿ¨ÿ±ÿ®ÿ™ŸÉ ŸÖÿπ...ÿü\nÿ•ÿ≤ÿßŸä ÿ®ÿ™ÿ™ÿπÿßŸÖŸÑ ŸÖÿπ...ÿü\nÿ•ŸäŸá ÿ£ŸÉÿ™ÿ± ÿ≠ÿßÿ¨ÿ© ÿ®ÿ™ÿ∂ÿßŸäŸÇŸÉ ŸÅŸä...ÿü';
    if(co) co.placeholder='ÿ¥ŸÉÿ±ÿßŸã ÿ¨ÿØÿßŸã ÿπŸÑŸâ ŸàŸÇÿ™ŸÉ! ÿ¢ÿ±ÿßÿ°ŸÉ ŸÖŸáŸÖÿ© ÿ¨ÿØÿßŸã ŸàŸáÿ™ÿ≥ÿßÿπÿØŸÜÿß ŸÜÿ≠ÿ≥ŸëŸÜ...';
  }else{
    if(ci) ci.placeholder='Hi! Thanks for joining us today. We\'re conducting research about...';
    if(cq) cq.placeholder='What\'s your experience with...?\nHow do you currently handle...?\nWhat frustrates you most about...?';
    if(co) co.placeholder='Thank you so much for your time! Your insights are incredibly valuable and will help us improve...';
  }
  // Step 2 add-question input
  const aq=document.getElementById('add-q-in');
  if(aq){aq.dir=dir;aq.placeholder=isAr?'ÿ£ÿ∂ŸÅ ÿ≥ÿ§ÿßŸÑ ÿ™ÿßŸÜŸä...':'Add another question...';}
  // Transcript input
  const ui=document.getElementById('user-input');
  if(ui){ui.dir=dir;ui.placeholder=isAr?'ÿßŸÉÿ™ÿ® ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ...':'Type your answer...';}
}
function renderTones(){const el=document.getElementById('tone-buttons');['Casual & Friendly','Professional','Deep & Probing'].forEach(t=>{const b=document.createElement('button');b.style.cssText='padding:10px 18px;border-radius:10px;border:none;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s;'+(t===selectedTone?'background:linear-gradient(135deg,#10B981,#34D399);color:#FFF;box-shadow:0 4px 15px rgba(16,185,129,0.3);':'background:rgba(255,255,255,0.06);color:#8A8580;');b.textContent=t;b.onclick=()=>{selectedTone=t;el.querySelectorAll('button').forEach(x=>{x.style.background='rgba(255,255,255,0.06)';x.style.color='#8A8580';x.style.boxShadow='none';});b.style.background='linear-gradient(135deg,#10B981,#34D399)';b.style.color='#FFF';b.style.boxShadow='0 4px 15px rgba(16,185,129,0.3)';};el.appendChild(b);});}
function getCfg(){return{projectName:document.getElementById('project-name').value.trim(),objective:document.getElementById('objective').value.trim(),cohort:document.getElementById('cohort').value.trim(),tone:selectedTone,questions:[...questions]};}
function fmtT(s){return Math.floor(s/60).toString().padStart(2,'0')+':'+(s%60).toString().padStart(2,'0');}

init();
</script>
</body>
</html>
